<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Master Daftar Hadir - Admin Dashboard</title>
    <%- include('../../partials/head') %>
    <link href="<%= hostname %>dashboard/css/styles.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" />
    <!-- Add SweetAlert2 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script data-search-pseudo-elements defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js" crossorigin="anonymous"></script>
</head>

<body class="nav-fixed">
    <%- include('partials/topNav') %>
    <div id="layoutSidenav">
        <%- include('partials/sideNav') %>
        <div id="layoutSidenav_content">
            <main>
                <header class="page-header page-header-dark bg-gradient-primary-to-secondary pb-10">
                    <div class="container-xl px-4">
                        <div class="page-header-content pt-4">
                            <div class="row align-items-center justify-content-between">
                                <div class="col-auto mt-4">
                                    <h1 class="page-header-title">
                                        <div class="page-header-icon"><i data-feather="clipboard"></i></div>
                                        Daftar Hadir Tentor
                                    </h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="container-xl px-4 mt-n10">
                    <div class="card mb-4">
                        <div class="card-body">
                            <form class="row align-items-center" method="GET">
                                <div class="col-md-4">
                                    <label class="form-label">Bulan</label>
                                    <select name="month" class="form-select">
                                        <option value="1" <%= selectedMonth == 1 ? 'selected' : '' %>>Januari</option>
                                        <option value="2" <%= selectedMonth == 2 ? 'selected' : '' %>>Februari</option>
                                        <option value="3" <%= selectedMonth == 3 ? 'selected' : '' %>>Maret</option>
                                        <option value="4" <%= selectedMonth == 4 ? 'selected' : '' %>>April</option>
                                        <option value="5" <%= selectedMonth == 5 ? 'selected' : '' %>>Mei</option>
                                        <option value="6" <%= selectedMonth == 6 ? 'selected' : '' %>>Juni</option>
                                        <option value="7" <%= selectedMonth == 7 ? 'selected' : '' %>>Juli</option>
                                        <option value="8" <%= selectedMonth == 8 ? 'selected' : '' %>>Agustus</option>
                                        <option value="9" <%= selectedMonth == 9 ? 'selected' : '' %>>September</option>
                                        <option value="10" <%= selectedMonth == 10 ? 'selected' : '' %>>Oktober</option>
                                        <option value="11" <%= selectedMonth == 11 ? 'selected' : '' %>>November</option>
                                        <option value="12" <%= selectedMonth == 12 ? 'selected' : '' %>>Desember</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tahun</label>
                                    <select name="year" class="form-select">
                                        <% for(let y = currentYear; y >= 2023; y--) { %>
                                            <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i data-feather="filter" class="me-1"></i>Filter
                                        </button>
                                        <a href="/admin/daftar-hadir" class="btn btn-secondary">
                                            <i data-feather="refresh-cw" class="me-1"></i>Reset
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Daftar Hadir Tentor</div>
                        <div class="card-body">
                            <div class="alert-container"></div>
                            <div class="table-responsive">
                                <table id="datatablesSimple" class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Tentor</th>
                                            <th>Siswa/Kelas</th>
                                            <th>Mata Pelajaran</th>
                                            <th>Kode Hadir</th>
                                            <th>Status</th>
                                            <th>Materi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% schedules.forEach(schedule => { %>
                                            <tr>
                                                <td><%= new Date(schedule.date).toLocaleDateString('id-ID') %></td>
                                                <td><%= schedule.tentor.nama %></td>
                                                <td>
                                                    <% if (schedule.type === 'class') { %>
                                                        <%= schedule.class.name %>
                                                    <% } else { %>
                                                        <%= schedule.siswa.nama %>
                                                    <% } %>
                                                </td>
                                                <td><%= schedule.mataPelajaran %></td>
                                                <td>
                                                    <% if (schedule.status !== 'canceled') { %>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control form-control-sm" value="<%= schedule.attendanceCode %>" readonly>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="copyCode('<%= schedule.attendanceCode %>')">
                                                                <i data-feather="copy"></i>
                                                            </button>
                                                        </div>
                                                    <% } else { %>
                                                        <span class="text-muted">Kode Hadir tidak tersedia</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (schedule.isAttendanceMarked) { %>
                                                        <span class="badge text-white bg-success">Hadir</span>
                                                    <% } else if (schedule.status === 'canceled') { %>
                                                        <span class="badge text-white bg-danger">Dibatalkan</span>
                                                    <% } else { %>
                                                        <span class="badge text-white bg-primary">Belum Hadir</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (schedule.materiYangDiajarkan) { %>
                                                        <button class="btn btn-sm btn-info" onclick="showMateri('<%= schedule.materiYangDiajarkan %>')">
                                                            <i data-feather="eye"></i> Lihat
                                                        </button>
                                                    <% } else { %>
                                                        -
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <%- include('../../partials/footer-dashboard') %>
        </div>
    </div>

    <!-- Materi Modal -->
    <div class="modal fade" id="materiModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Materi yang Diajarkan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="materiContent"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" crossorigin="anonymous"></script>
        <script src="<%= hostname %>dashboard/js/scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
    <script>
        // Initialize DataTable
        const datatablesSimple = document.getElementById('datatablesSimple');
        if (datatablesSimple) {
            const dataTable = new simpleDatatables.DataTable(datatablesSimple);

            // Reinitialize Feather icons after search event
            dataTable.on('datatable.search', () => {
                feather.replace();
            });

            // Reinitialize Feather icons after pagination
            dataTable.on('datatable.page', () => {
                feather.replace();
            });

            // Reinitialize Feather icons after sorting
            dataTable.on('datatable.sort', () => {
                feather.replace();
            });

            // Reinitialize Feather icons when the search input changes
            const searchInput = datatablesSimple.querySelector('.dataTable-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    feather.replace();
                });

                // Detect when the "X" button is pressed (clearing the input)
                searchInput.addEventListener('search', () => {
                    feather.replace();
                });
            }
        }

        // Copy code function
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Kode Berhasil Disalin',
                    showConfirmButton: false,
                    timer: 1500
                });
            }).catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Menyalin Kode',
                    text: 'Terjadi kesalahan saat menyalin kode'
                });
                console.error('Failed to copy code:', err);
            });
        }

        // Show materi function
        function showMateri(materi) {
            document.getElementById('materiContent').textContent = materi;
            new bootstrap.Modal(document.getElementById('materiModal')).show();
        }

        // Replace alert handling with SweetAlert2 implementation
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            const error = urlParams.get('error');

            if (message || error) {
                Swal.fire({
                    title: error ? 'Error!' : 'Berhasil!',
                    text: message || error,
                    icon: error ? 'error' : (message.toLowerCase().includes('hapus') ? 'warning' : 'success'),
                    confirmButtonColor: error ? '#dc3545' : '#28a745',
                    confirmButtonText: 'OK'
                });

                // Clear the URL parameters
                const url = new URL(window.location.href);
                url.searchParams.delete('message');
                url.searchParams.delete('error');
                window.history.replaceState({}, document.title, url);
            }
        });
    </script>
    
    <!-- Load essential scripts for layout functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" crossorigin="anonymous"></script>
        <script src="<%= hostname %>dashboard/js/scripts.js"></script>
    
    <!-- Simple DataTables -->
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
    <script src="<%= hostname %>dashboard/js/datatables/datatables-simple-demo.js"></script>
</body>
</html> 